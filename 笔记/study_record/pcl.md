# pcl点云配准

## 工作流程

![](/home/maple/笔记/images/2025-07-08-15-04-13-pcl配准.png)

## RANSAC粗配准

```
目标​​：估算初始变换矩阵（6DOF刚体变换）
​​处理流程​​：
    ​​特征匹配​​：
        在特征空间中通过KD-Tree搜索匹配点对
        输出：一组候选匹配点对（含大量噪声）
    ​​RANSAC迭代​​：
        随机采样3组点对
        估算变换矩阵（SVD求解最小二乘解）
    ​​变换评估​​：
        应用当前变换到源关键点
        计算目标点云中对应点的距离
        统计内点数量（距离<阈值）
    ​​最优选择​​：
        保留内点最多的变换矩阵
        使用内点重新估计精确变换
```

## 应用初始变化

**目的​**​：将源点云初步对齐到目标点云附近

## ICP精配准​

```
 目标​​：优化变换矩阵达到亚毫米级精度
    迭代过程：
    ​流程控制​：最大迭代次数(100) + 变换收敛阈值(1e-6)
        ​​最近点搜索​​：
            KD-Tree查找源点在目标点云中的最近邻
            剔除异常点（距离 > 3倍点云平均密度）
        ​​误差最小化​​： R,tmin​i=1∑n​∣∣qi​−(Rpi​+t)∣∣2
            使用SVD分解求解最优R（旋转）和t（平移）
        ​​变换更新​​： Ticp​←[R0​t1​]⋅Ticp​
            累积变换矩阵
        ​​收敛判断​​：
            δ = 当前迭代的均方误差变化量
            终止条件：δ < ε 或 达到最大迭代次数

 ​结果输出​​： 最终变换​​： Tfinal​=Ticp​⋅Trough
```

## NDT点云配准

NDT是一种用于​**​对齐（配准）​**​ 两个点云（Point Cloud）的算法。它的核心思想是​**​概率模型匹配​**​，与传统ICP（Iterative Closest Point）的点对点匹配思路不同

> 1. ​**​预处理参考点云：​**​
>    
>    - ​**​设定网格大小：​**​ 这是关键参数！尺寸太小，效率低且对噪声敏感；尺寸太大，丢失细节，模型粗糙。需要根据点云密度和应用场景选择。
>    - ​**​划分网格：​**​ 根据设定尺寸，将参考点云的空间划分成规则网格。
>    - ​**​计算网格属性：​**​ 对每个包含至少一定数量（如3个）点的非空网格，计算其均值和协方差矩阵，并存储。
> 
> 2. ​**​初始化变换参数：​**​
>    
>    - 提供一个初始的猜测变换（R0, t0）。这个初始值越接近真实值，效果越好。可以是零（假设点云大致重合）、手动旋转平移、或者来自其他粗配准方法（如基于特征）的粗略估计。​**​NDT的鲁棒性意味着它可以容忍比ICP更大的初始偏差。​**​
> 
> 3. ​**​迭代优化：​**​
>    
>    - 对当前变换后的源点云每个点 `x_i_transformed`:  
>      a) 根据其位置找到对应的​**​参考网格单元​**​。  
>      b) 如果该网格是​**​非空且有效的​**​（点数量大于阈值，协方差条件良好），则计算 `p(x_i_transformed)`。
>    - 将所有点的 `p(x_i_transformed)` 累加（或平均）得到当前得分 `S`。
>    - 计算得分函数 `S` 对变换参数（旋转的欧拉角或四元数、平移分量）的​**​导数​**​（梯度/Jacobian/Hessian，具体取决于使用的优化器）。
>    - 优化器根据函数值和导数信息，计算一个更新量 `Δp` 来改进变换参数 `p = (R, t)`。
>    - `p_new = p_old + Δp` （或在优化器内部表示的参数空间上进行更新）。
>    - 判断是否收敛（函数值变化小、参数变化小、达到最大迭代次数）？如果否，转到步骤3开头。
> 
> 4. ​**​输出最优变换：​**​
>    
>    - 将优化得到的最优变换（R*, t*) 作为最终配准结果输出。

## NDT和RANSAC对比

![](/home/maple/笔记/images/2025-07-08-19-25-41-NR1.png)

![](/home/maple/笔记/images/2025-07-08-19-25-46-NR2.png)

**变换矩阵的含义（通常情况）：​**​ 经过 RANSAC (粗配准) 和 ICP (精配准) 后得到的变换矩阵 ​**​T​**​ ​**​通常表示“当前点云坐标系”相对于“目标点云坐标系”的变换​**​

**这个目标点云的坐标系原点(0,0,0)和坐标轴方向，就是你所定义的“世界坐标系”的具体位置和方向**

**变换矩阵 T**

```
[ R     t ]
[ 0 0 0 1 ]
```

`R`: 3x3 的​**​旋转矩阵​**​。描述了当前坐标系相对于世界坐标系的旋转。

`t`: 3x1 的​**​平移向量​**​。描述了当前坐标系​**​原点​**​在世界坐标系中的坐标位置 `(x, y, z)`

### PCL中的SAC-IA算法详解（Sample Consensus - Initial Alignment）

SAC-IA（Sample Consensus Initial Alignment）是点云库（PCL）中用于​**​点云粗配准（Coarse Registration）​**​ 的核心算法

> - **​初始位姿估计​**​：解决两个点云间存在较大旋转/平移时（>30°），ICP等精细配准算法无法收敛的问题
> - ​**​特征驱动配准​**​：基于局部几何特征（如法线、曲率）进行鲁棒匹配
> - ​**​点云预处理​**​：为ICP等精细配准提供良好的初始变换矩阵
> - 典型应用领域：三维重建、SLAM、物体识别、医学图像对齐

## ICP执行流程

![](/home/maple/笔记/images/2025-07-10-17-41-07-ICP.png)

## 将点云从A变化到B

```cpp
pcl::transformPointCloud(*cloud, *transformed_cloud, transform2);
```

这是对点云作变化而非坐标系, transform2是cloud坐标系到transformed坐标系的变化矩阵
